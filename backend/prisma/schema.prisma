generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String              @id @default(cuid())
  walletAddress       String?             @unique @map("wallet_address")
  email               String?             @unique
  displayName         String?             @map("display_name")
  isActive            Boolean             @default(true) @map("is_active")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  authProvider        AuthProvider        @default(EMAIL) @map("auth_provider")
  avatarUrl           String?             @map("avatar_url")
  emailVerified       Boolean             @default(false) @map("email_verified")
  googleId            String?             @unique @map("google_id")
  smartWalletAddress  String?             @map("smart_wallet_address")
  auditLogs             AuditLog[]
  biometricIdentities   BiometricIdentity[]
  credentials           Credential[]
  documents             Document[]
  investments           Investment[]
  recoveryCodes         RecoveryCode[]
  sessions              Session[]
  positionHighWatermarks PositionHighWatermark[]
  redemptionQueues      RedemptionQueue[]
  poolSwaps             PoolSwap[]

  @@index([googleId])
  @@index([authProvider])
  @@map("users")
}

model BiometricIdentity {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  credentialId  String    @unique @map("credential_id")
  publicKeyX    String    @map("public_key_x")
  publicKeyY    String    @map("public_key_y")
  authCounter   Int       @default(0) @map("auth_counter")
  deviceInfo    Json?     @map("device_info")
  onChainTxHash String?   @map("on_chain_tx_hash")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  aaguid        String?   @map("aaguid")
  deviceName    String?   @map("device_name")
  lastUsedAt    DateTime? @map("last_used_at")
  lastUsedIp    String?   @map("last_used_ip")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("biometric_identities")
}

model RecoveryCode {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  codeHash  String    @map("code_hash")
  used      Boolean   @default(false)
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("recovery_codes")
}

model Credential {
  id             String           @id @default(cuid())
  userId         String           @map("user_id")
  credentialType CredentialType   @map("credential_type")
  jurisdiction   String
  tier           Int              @default(1)
  status         CredentialStatus @default(PENDING)
  issuerAddress  String?          @map("issuer_address")
  onChainTxHash  String?          @map("on_chain_tx_hash")
  issuedAt       DateTime?        @map("issued_at")
  expiresAt      DateTime?        @map("expires_at")
  metadata       Json?
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("credentials")
}

model AssetPool {
  id                        String            @id @default(cuid())
  chainPoolId               Int               @unique @map("chain_pool_id")
  name                      String
  assetClass                AssetClass        @map("asset_class")
  rwaTokenAddress           String            @map("rwa_token_address")
  yieldRateBps              Int               @map("yield_rate_bps")
  totalDeposited            BigInt            @default(0) @map("total_deposited")
  investorCount             Int               @default(0) @map("investor_count")
  minInvestment             BigInt            @map("min_investment")
  maxInvestment             BigInt            @map("max_investment")
  status                    PoolStatus        @default(ACTIVE)
  metadata                  Json?
  createdAt                 DateTime          @default(now()) @map("created_at")
  updatedAt                 DateTime          @updatedAt @map("updated_at")
  navPerShare               BigInt            @default(100000000) @map("nav_per_share")
  lastNavUpdate             DateTime          @default(now()) @map("last_nav_update")
  // Redemption queue settings
  settlementDays            Int               @default(1) @map("settlement_days")
  largeRedemptionThreshold  BigInt?           @map("large_redemption_threshold")
  // Relations
  investments               Investment[]
  yieldHistory              YieldHistory[]
  feeConfig                 FeeConfig?
  navHistory                NavHistory[]
  accruedFees               AccruedFee[]
  redemptionQueues          RedemptionQueue[]
  sourceSwaps               PoolSwap[]        @relation("SourcePool")
  targetSwaps               PoolSwap[]        @relation("TargetPool")

  @@index([assetClass])
  @@index([status])
  @@map("asset_pools")
}

model Investment {
  id                   String           @id @default(cuid())
  userId               String           @map("user_id")
  poolId               String           @map("pool_id")
  type                 InvestmentType
  amount               BigInt
  shares               BigInt
  status               InvestmentStatus @default(PENDING)
  txHash               String?          @map("tx_hash")
  blockNumber          Int?             @map("block_number")
  sharePriceAtPurchase BigInt?          @map("share_price_at_purchase")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")
  pool                 AssetPool        @relation(fields: [poolId], references: [id])
  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([poolId])
  @@index([status])
  @@map("investments")
}

model YieldHistory {
  id              String    @id @default(cuid())
  poolId          String    @map("pool_id")
  yieldAmount     BigInt    @map("yield_amount")
  cumulativeYield BigInt    @map("cumulative_yield")
  recordedAt      DateTime  @default(now()) @map("recorded_at")
  pool            AssetPool @relation(fields: [poolId], references: [id])

  @@index([poolId])
  @@map("yield_history")
}

model Document {
  id           String   @id @default(cuid())
  documentHash String   @unique @map("document_hash")
  title        String
  signerId     String   @map("signer_id")
  txHash       String?  @map("tx_hash")
  sealedAt     DateTime @default(now()) @map("sealed_at")
  metadata     Json?
  signer       User     @relation(fields: [signerId], references: [id])

  @@index([signerId])
  @@map("documents")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model EmailVerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String
  expiresAt DateTime @map("expires_at")
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@index([expiresAt])
  @@map("email_verification_codes")
}

model IndexedEvent {
  id              String   @id @default(cuid())
  eventId         String   @unique @map("event_id")
  contractAddress String   @map("contract_address")
  eventName       String   @map("event_name")
  blockNumber     Int      @map("block_number")
  blockHash       String   @map("block_hash")
  txHash          String   @map("tx_hash")
  logIndex        Int      @map("log_index")
  args            Json
  reorged         Boolean  @default(false)
  indexedAt       DateTime @default(now()) @map("indexed_at")

  @@index([contractAddress])
  @@index([eventName])
  @@index([blockNumber])
  @@map("indexed_events")
}

model AuditLog {
  id           String   @id @default(cuid())
  action       String
  userId       String?  @map("user_id")
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id")
  metadata     Json?
  ipAddress    String?  @map("ip_address")
  status       String
  createdAt    DateTime @default(now()) @map("created_at")
  user         User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuthProvider {
  EMAIL
  GOOGLE
  WALLET

  @@map("auth_provider")
}

enum CredentialType {
  ACCREDITED
  QUALIFIED
  INSTITUTIONAL
  RETAIL_RESTRICTED
}

enum CredentialStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  REVOKED
}

enum AssetClass {
  TREASURY
  REAL_ESTATE
  PRIVATE_CREDIT
  COMMODITIES
  CORPORATE_BONDS
}

enum PoolStatus {
  ACTIVE
  PAUSED
  CLOSED
}

enum InvestmentType {
  INVEST
  REDEEM
}

enum InvestmentStatus {
  PENDING
  CONFIRMED
  FAILED
}

// ==================== Fee System ====================

model FeeConfig {
  id                String    @id @default(cuid())
  poolId            String    @unique @map("pool_id")
  managementFeeBps  Int       @default(50) @map("management_fee_bps") // 0.5% annually
  performanceFeeBps Int       @default(1000) @map("performance_fee_bps") // 10% of yield
  entryFeeBps       Int       @default(0) @map("entry_fee_bps")
  exitFeeBps        Int       @default(10) @map("exit_fee_bps") // 0.1%
  feeRecipient      String    @map("fee_recipient")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  pool              AssetPool @relation(fields: [poolId], references: [id])

  @@map("fee_configs")
}

model AccruedFee {
  id        String    @id @default(cuid())
  poolId    String    @map("pool_id")
  feeType   FeeType   @map("fee_type")
  amount    BigInt
  period    String    // Date string: "2026-02-08"
  status    FeeStatus @default(PENDING)
  txHash    String?   @map("tx_hash")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  pool      AssetPool @relation(fields: [poolId], references: [id])

  @@index([poolId])
  @@index([status])
  @@index([period])
  @@map("accrued_fees")
}

model PositionHighWatermark {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  poolId           String   @map("pool_id")
  highWatermarkNav BigInt   @map("high_watermark_nav")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, poolId])
  @@map("position_high_watermarks")
}

enum FeeType {
  ENTRY
  EXIT
  MANAGEMENT
  PERFORMANCE
}

enum FeeStatus {
  PENDING
  COLLECTED
  FAILED
}

// ==================== NAV System ====================

model NavHistory {
  id          String    @id @default(cuid())
  poolId      String    @map("pool_id")
  navPerShare BigInt    @map("nav_per_share")
  previousNav BigInt    @map("previous_nav")
  source      NavSource @default(ADMIN)
  adminId     String?   @map("admin_id")
  reason      String?
  txHash      String?   @map("tx_hash")
  createdAt   DateTime  @default(now()) @map("created_at")
  pool        AssetPool @relation(fields: [poolId], references: [id])

  @@index([poolId])
  @@index([createdAt])
  @@map("nav_history")
}

enum NavSource {
  ADMIN
  SIMULATION
  ORACLE
}

// ==================== Redemption Queue ====================

model RedemptionQueue {
  id               String           @id @default(cuid())
  userId           String           @map("user_id")
  poolId           String           @map("pool_id")
  shares           BigInt
  queuePosition    Int              @map("queue_position")
  navAtRequest     BigInt           @map("nav_at_request")
  estimatedAmount  BigInt           @map("estimated_amount")
  settlementDate   DateTime         @map("settlement_date")
  status           RedemptionStatus @default(QUEUED)
  requiresApproval Boolean          @default(false) @map("requires_approval")
  approvedBy       String?          @map("approved_by")
  filledShares     BigInt           @default(0) @map("filled_shares")
  txHash           String?          @map("tx_hash")
  reason           String?          // For rejection/cancellation reason
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  pool             AssetPool        @relation(fields: [poolId], references: [id])

  @@index([userId])
  @@index([poolId])
  @@index([status])
  @@index([settlementDate])
  @@map("redemption_queue")
}

enum RedemptionStatus {
  QUEUED
  PENDING_APPROVAL
  APPROVED
  PROCESSING
  PARTIALLY_FILLED
  SETTLED
  CANCELLED
  REJECTED
  FAILED
}

// ==================== Pool Swaps ====================

model PoolSwap {
  id              String     @id @default(cuid())
  userId          String     @map("user_id")
  sourcePoolId    String     @map("source_pool_id")
  targetPoolId    String     @map("target_pool_id")
  sharesSwapped   BigInt     @map("shares_swapped")
  sourceAmount    BigInt     @map("source_amount")
  targetAmount    BigInt     @map("target_amount")
  targetShares    BigInt     @map("target_shares")
  fee             BigInt     @default(0)
  sourceNavAtSwap BigInt     @map("source_nav_at_swap")
  targetNavAtSwap BigInt     @map("target_nav_at_swap")
  slippageBps     Int        @default(50) @map("slippage_bps") // 0.5%
  minOutputAmount BigInt?    @map("min_output_amount")
  status          SwapStatus @default(PENDING)
  txHash          String?    @map("tx_hash")
  errorMessage    String?    @map("error_message")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourcePool      AssetPool  @relation("SourcePool", fields: [sourcePoolId], references: [id])
  targetPool      AssetPool  @relation("TargetPool", fields: [targetPoolId], references: [id])

  @@index([userId])
  @@index([sourcePoolId])
  @@index([targetPoolId])
  @@index([status])
  @@map("pool_swaps")
}

enum SwapStatus {
  PENDING
  BUILDING
  AWAITING_SIGNATURE
  SUBMITTED
  CONFIRMED
  FAILED
  CANCELLED
}
